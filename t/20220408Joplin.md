# 折腾Joplin

第一次同步的时候，我把笔记都弄丢了
我已经用Joplin有一段时间了，我感觉很好，我打算用它来代替Evernote。
昨天我试着第一次同步功能,我设置WebDav环境,MacOS桌面端开始同步,一切似乎很好,所以我打开了手机同步,一段时间后,我发现没有音符出现在电话,但所有的音符在桌面端已经删除!
我急忙检查服务器，发现那里有数百个md文件，但无论如何，电话端和桌面端仍然没有任何笔记。

1. 从enex导入300条笔记
2. 配置WebDav同步，地址如：http://192.168.1.10/dav/files/username
3. 同步。同步完成后，发现所有文件都在写入到了dav的根目录，而没有建立子目录。
4. 在服务端建立了joplin_sync文件夹，将所有文件移动到其中，修改客户端配置，WebDav地址改为http://192.168.1.10/dav/files/username/joplin_sync，手机上也同样设置
5. 重新同步，此时并未发生问题，此时开启了手机同步
6. 过了一会，发现桌面端所有的笔记全部被删除了。


文件夹定义的元数据（7ca288ed56da47a0b0d361ca6d0784fe.md）
```
2022-0319develop

id: 7ca288ed56da47a0b0d361ca6d0784fe
created_time: 2022-04-07T14:34:20.198Z
updated_time: 2022-04-07T14:34:20.198Z
user_created_time: 2022-04-07T14:34:20.198Z
user_updated_time: 2022-04-07T14:34:20.198Z
encryption_cipher_text:
encryption_applied: 0
parent_id:
is_shared: 0
share_id:
master_key_id:
icon:
type_: 2
```

文件夹里的笔记的元数据
```
id: fdf2e12b150f4abd977012356fde026d
parent_id: 7ca288ed56da47a0b0d361ca6d0784fe
created_time: 2018-12-23T15:23:55.000Z
updated_time: 2022-03-09T05:47:12.000Z
is_conflict: 0
latitude: 0.00000000
longitude: 0.00000000
altitude: 0.0000
author:
source_url: https://jingyan.baidu.com/article/8cdccae9438422315413cde1.html
is_todo: 0
todo_due: 0
todo_completed: 0
source: evernote
source_application: net.cozic.joplin-desktop
application_data:
order: -62167248343000
user_created_time: 2018-12-23T15:23:55.000Z
user_updated_time: 2022-03-09T05:47:12.000Z
encryption_cipher_text:
encryption_applied: 0
markup_language: 1
is_shared: 0
share_id:
conflict_original_id:
master_key_id:
type_: 1
```

develop
fafe4136b5104912a6332b43821eef44.md

-rw-r--r-- 1 www-data www-data 12932 Apr  7 13:47 25a2ad4435d743b6a2be7aed9238775c.md
-rw-r--r-- 1 www-data www-data  5304 Apr  7 14:59 57d15aa767ef4a82b153342cf655fbb3.md
-rw-r--r-- 1 www-data www-data  4612 Apr  7 14:55 77ec0057b4934ba691ec94c945dd528a.md
-rw-r--r-- 1 www-data www-data 11508 Apr  7 13:48 f0007f9a94c746f6857526e0ee4cc2a8.md

25a2ad4435d743b6a2be7aed9238775c.md的parent_id为空

196c24a7f530465c9749e443cc019e77.md:NewNote
49c65e5584e54005b367576b7ffe0035.md:title_diff: "[{\"diffs\":[[1,\"NewNote\"]],\"start1\":0,\"start2\":0,\"length1\":0,\"length2\":7}]"


发现每个笔记可能存在多个文件，其他的文件看内容，推测是`笔记历史`这个功能产生的：
```
f23b63db12bd41396d2ac18fa3b44c94.md 笔记
f0007f9a94c746f6857526e0ee4cc2a8.md diff
57d15aa767ef4a82b153342cf655fbb3.md diff
25a2ad4435d743b6a2be7aed9238775c.md diff
```

对比笔记和正常笔记的差异，只有`type_: 1`一项不同。

查询源代码`packages/lib/BaseModel.js`，发现type_的含义是
```
export enum ModelType {
	Note = 1,
	Folder = 2,
	Setting = 3,
	Resource = 4,
	Tag = 5,
	NoteTag = 6,
	Search = 7,
	Alarm = 8,
	MasterKey = 9,
	ItemChange = 10,
	NoteResource = 11,
	ResourceLocalState = 12,
	Revision = 13,
	Migration = 14,
	SmartFilter = 15,
	Command = 16,
}
```
只是标示了是普通笔记（区分是文件夹还是标签等），并没有什么特别的。

为什么不能被识别为正常笔记而进行同步呢，看遍了服务器端的文件，似乎并没有索引文件。

于是想可能还是本地记录了笔记索引，查看Joplin目录，发现存在一个`database.sqlite`，打开查看`SELECT * FROM  notes;`，发现果然是笔记索引。表结构刚好和笔记中的元数据一致：
```
PRAGMA table_info(notes);
0	id	TEXT	0		1
1	parent_id	TEXT	1	""	0
2	title	TEXT	1	""	0
3	body	TEXT	1	""	0
4	created_time	INT	1		0
5	updated_time	INT	1		0
6	is_conflict	INT	1	0	0
7	latitude	NUMERIC	1	0	0
8	longitude	NUMERIC	1	0	0
9	altitude	NUMERIC	1	0	0
10	author	TEXT	1	""	0
11	source_url	TEXT	1	""	0
12	is_todo	INT	1	0	0
13	todo_due	INT	1	0	0
14	todo_completed	INT	1	0	0
15	source	TEXT	1	""	0
16	source_application	TEXT	1	""	0
17	application_data	TEXT	1	""	0
18	order	NUMERIC	1	0	0
19	user_created_time	INT	1	0	0
20	user_updated_time	INT	1	0	0
21	encryption_cipher_text	TEXT	1	""	0
22	encryption_applied	INT	1	0	0
23	markup_language	INT	1	1	0
24	is_shared	INT	1	0	0
25	share_id	TEXT	1	""	0
26	conflict_original_id	TEXT	1	""	0
27	master_key_id	TEXT	1	""	0
```

尝试添加记录，Joplin中就可以看到对应的笔记了。

所以，Joplin的原理，是笔记内容和元数据保存到本地sqlite数据库，同步的话，会把每个笔记以md文件形式保存到服务器，其他端再进行同步。

所以推测备份数据的话，备份`database.sqlite`就可以了。
